<!doctype html><html lang=en-us><head><title>Datadog, Serverless and AWS Lambda: "datadog:handler not initialized" issue // Berug0</title><link rel="shortcut icon" href=/images/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.94.2"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Gustavo Falco"><meta name=description content="How to fix the &#34;datadog:handler not initialized&#34; error in aws lambda when using the datadog-lambda-js component"><link rel=stylesheet href=https://comfortablynumb.github.io/css/main.min.4afb4d293f13adab3fe7f693fcdbced8f4a2ae0afa72a878a9de2d0e8e7d4b35.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-R9B3CPPMVE"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-R9B3CPPMVE",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary"><meta name=twitter:title content="Datadog, Serverless and AWS Lambda: &#34;datadog:handler not initialized&#34; issue"><meta name=twitter:description content="How to fix the &#34;datadog:handler not initialized&#34; error in aws lambda when using the datadog-lambda-js component"><meta property="og:title" content="Datadog, Serverless and AWS Lambda: &#34;datadog:handler not initialized&#34; issue"><meta property="og:description" content="How to fix the &#34;datadog:handler not initialized&#34; error in aws lambda when using the datadog-lambda-js component"><meta property="og:type" content="article"><meta property="og:url" content="https://comfortablynumb.github.io/posts/development/datadog_handler_not_initialized/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-16T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-16T00:00:00+00:00"></head><body><header class=app-header><a href=https://comfortablynumb.github.io><img class=app-header-avatar src=/images/logo.jpg alt="Gustavo Falco"></a><h1>Berug0</h1><p>Some thoughts about software development, retro games and movies from the good old 80s</p><div class=app-header-social><a href=https://github.com/comfortablynumb target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>My Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://www.linkedin.com/in/gustavofalco target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin"><title>My LinkedIn</title><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Datadog, Serverless and AWS Lambda: "datadog:handler not initialized" issue</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Mar 16, 2022</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://comfortablynumb.github.io/tags/datadog/>datadog</a>
<a class=tag href=https://comfortablynumb.github.io/tags/aws/>aws</a>
<a class=tag href=https://comfortablynumb.github.io/tags/lambda/>lambda</a>
<a class=tag href=https://comfortablynumb.github.io/tags/serverless/>serverless</a></div></div></header><div class=post-content><hr><p>In this post I&rsquo;ll describe how to fix the <strong>datadog:handler not initialized</strong> issue, which may happen to you if you&rsquo;re using the
<a href=https://github.com/DataDog/datadog-lambda-js>datadog-lambda-js</a> library in a project deployed in a lambda which already
has the <strong>Datadog Lambda layer</strong>.</p><p>The fix described here applies to projects using <a href=https://github.com/serverless/serverless>Serverless</a>
with the <a href=https://github.com/serverless-heaven/serverless-webpack>serverless-webpack</a> plugin. Nevertheless, if you&rsquo;re not using
these tools, but you&rsquo;re having this issue anyway, the solution described here may also be useful for you since the way to fix it
is probably very similar.</p><hr><h3 id=article-contents>Article Contents</h3><ul><li><a href=#problem-description>Problem Description</a></li><li><a href=#how-to-fix-it>How to Fix it?</a></li><li><a href=#additional-information>Additional Information</a></li><li><a href=#conclusion>Conclusion</a></li></ul><h3 id=problem-description>Problem Description</h3><p>This error appears when you try to send a metric with, for example, the <strong>sendDistributionMetricWithDate</strong> function from the <strong>datadog-lambda-js</strong> library. Looking at
the code of <a href=https://github.com/DataDog/datadog-lambda-js/blob/35580a1efb714e25b5c7db1310efeee3132fc6e3/src/index.ts#L181>this function</a>,
we can see that the error is logged when the <strong>currentMetricsListener</strong> variable is not set. This variable is set <a href=https://github.com/DataDog/datadog-lambda-js/blob/35580a1efb714e25b5c7db1310efeee3132fc6e3/src/index.ts#L115>here</a>, which basically happens when
your lambda function being wrapped by this library is executed.</p><p>So, with this information, we can conclude that:</p><ul><li>The error happens if <strong>currentMetricsListener</strong> variable is not set.</li><li>This variable is always set just before our lambda function is executed.</li><li>Our lambda function is executed since we&rsquo;re calling a function from the <strong>datadog-lambda-js</strong> library to send some metrics.</li><li>With all this in mind: How is it possible that our lambda function is being called but the <strong>currentMetricsListener</strong> variable is still not set?</li></ul><p>The answer is: The <strong>datadog-lambda-js</strong> library is being loaded more than once! :O</p><p>The issue here is that the <strong>Datadog Lambda Layer</strong> already provides this library, so we must make sure we&rsquo;re not including it in our lambda inside the
<strong>node_modules</strong> directory. And here is the main problem lies: If you&rsquo;re using Serverless and its webpack plugin, there&rsquo;s a <a href=https://github.com/serverless-heaven/serverless-webpack/issues/306>known issue</a>
with the exclusion of transitive dependencies. So, even if you add <strong>datadog-lambda-js</strong> to the exclusion list, <strong>it&rsquo;s possible that
it&rsquo;s being included anyway!</strong>.</p><h3 id=how-to-fix-it>How to Fix it?</h3><p>The hard part was actually finding where the issue was. The fix is pretty straightforward. You just need to force the removal
of the <strong>datadog-lambda-js</strong> library from your <strong>node_modules</strong> before publishing your code to the lambda. In Serverless, you
can do it this way:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>custom</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>webpack</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>packagerOptions</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>scripts</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>rm -rf node_modules/datadog-lambda-js</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># Also, remember that some libraries may depend on datadog-lambda-js too, so this library could be </span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># embedded into their own node_modules directory.</span>
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>rm -rf node_modules/some-other-dependency/node-modules/datadog-lambda-js </span></span></span></code></pre></td></tr></table></div></div><p>If you&rsquo;re not using serverless and its webpack plugin, but you&rsquo;re still having this issue, the fix may be the same. Just
remove any <strong>datadog-lambda-js</strong> directory inside your <strong>node_modules</strong>.</p><p>To make sure that the library was effectively skipped when publishing your project, you can follow this steps:</p><ul><li>Go to the <strong>AWS Lambda</strong> section in the AWS Portal.</li><li>Search for your lambda.</li><li>Click on the <strong>Actions</strong> select and then choose the <strong>Export</strong> option.</li><li>Download the <strong>zip</strong> file containing the code that is published in your lambda.</li><li>Unzip it and search for the <strong>datadog-lambda-js</strong> folder inside <strong>node_modules</strong>. If at least one <strong>datadog-lambda-js</strong> folder is still there, make sure you&rsquo;ve used the correct commands to remove them!</li></ul><h3 id=additional-information>Additional Information</h3><ul><li>There&rsquo;s an <a href=https://github.com/DataDog/datadog-lambda-js/issues/209>issue in the datadog-lambda-js project</a> where I&rsquo;ve added a <a href=https://github.com/DataDog/datadog-lambda-js/issues/209#issuecomment-1024746511>comment</a> with these findings and the related <a href=https://github.com/DataDog/documentation/pull/12957>PR</a> with the corresponding update in the Datadog documentation.</li><li>And <a href=https://github.com/serverless-heaven/serverless-webpack/issues/306>here</a> is the related issue in the <strong>serverless-webpack</strong> plugin which mentions the problem with the exclusion of transitive dependencies.</li></ul><h3 id=conclusion>Conclusion</h3><p>And this is the end of the first post of my site. I hope this helps you guys to fix this annoying issue.</p><p>Sayonara!</p></div><div class=post-footer></div></article></main></body></html>